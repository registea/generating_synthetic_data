---
title: "Simulating Data"
author: "registea"
date: "23/07/2020"
output: github_document
---

<center><img src="https://github.com/registea/generating_synthetic_data/blob/master/Images/simulation.jpg?raw=true"></center>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

To apply analytics and data science principles, it is necessary to have access to data. There are many places where data is freely available, some examples are:

* Kaggle
* Wiki
* Data.gov

There are instances where open source doesn't meet your precise data needs. In these scenarios, it could be the perfect opportunity to generate synthetic data, which can be built and structured to your exact requirements. 

This post is going to use base R with a little help from the tidyverse, to demonstrate how a simple customer dataset can be generated. R provides access to popular theoretical probability distributions and allows us to sample values from them. Further to this, there is also functionality to sample from an empirical distribution. Utilising these two types of distributions, makes it very easy to generate data.

In this notebook, a dataset will be generated for 1 million customers. For each customer, data will be created to represent socio-demographics and sales information.

# Generating data

```{r libraries, echo=FALSE, warning=FALSE, message=FALSE}

# Load libraries
library(dplyr)
library(ggplot2)
```

The first step is to specify how many customers we want to have in our dataset. We will create 1 million customers in our dataset which will be denoted by the object n.

```{r n_customers}
# Number of customers
n <- 1000000
```

An empty dataframe is created with a single field created representing a customer id.

```{r dataframe_container}
# Create a dataframe
df_customer <- 
  data.frame(customer_id = 1:n)
```

The next step is to simulate the age and gender of each customer. 

* Age: It is assumed that customer's age follows a normal distribution with a mean age of 35 years old and a standard deviation of 10 years old. An additional condition is added to ensure that customers are at least 18 years old, a uniform sample is taken, changing any estimated age that is below 18 to be between 18 and 29
* Gender: Using the sample function, I randomly assign customers as male or female with a distribution split of 45% and 55% respectively

```{r age_gender}
# Customer Age
df_customer$age <- round(rnorm(n, 35, 10), 0)
df_customer$age <- ifelse(df_customer$age < 18, sample(18:29, 1), df_customer$age)

# Customer gender
df_customer$gender <- sample(c('Male','Female'), size = n, prob = c(0.45, 0.55), replace = T)
```

The next fields to be populated relate to the customer's marital status, the number of children they have and their living status. These new variables will all be conditioned on the customer's age. As an example, it has been assumed that customers under 30 have a 69% probability of  being single, compared to customers over 50 having a 80% probability of being married. Categorical variables 'marital status' and 'living status' are generated by sampling from categorical vectors with specific probabilities of occurrence. The number of children that a customer has is assumed to follow a poisson distribution with different lambda rates based the customer's age.

```{r marital_living_status_children}
# marital status
df_customer <-    
  mutate(df_customer, 
         marital_status = sapply(age, function(age) {
           case_when(
             age <= 30 ~ sample(c('Cohabiting','Married', 'Other', 'Single'), 
                                size = 1, 
                                prob = c(0.2, 0.1, 0.01, 0.69), 
                                replace = T),
             age <= 40 ~ sample(c('Cohabiting','Married', 'Other', 'Single'), 
                                size = 1, 
                                prob = c(0.4, 0.1, 0.01, 0.49), 
                                replace = T),
             age <= 50 ~ sample(c('Cohabiting','Married', 'Other', 'Single'), 
                                size = 1, 
                                prob = c(0.5, 0.4, 0.01, 0.29), 
                                replace = T),
             TRUE ~ sample(c('Cohabiting','Married', 'Other', 'Single'), 
                           size = 1, 
                           prob = c(0.09, 0.8, 0.01, 0.1),
                           replace = T)
             )}))


# No of children
df_customer <-    
  mutate(df_customer, 
         no_children = sapply(age, function(age) {
           case_when(
             age <= 20 ~ round(mean(rpois(n = 10, lambda = 0)), 0),
             age <= 30 ~ round(mean(rpois(n = 10, lambda = 1)), 0),
             age <= 40 ~ round(mean(rpois(n = 10, lambda = 2)), 0),
             age <= 50 ~ round(mean(rpois(n = 10, lambda = 2)), 0),
             TRUE ~ round(mean(rpois(n = 1, lambda = 3)), 0)
             )}))

# Living status
df_customer <-    
  mutate(df_customer, 
         living_status = sapply(age, function(age) {
           case_when(
             age <= 20 ~ sample(c('Living with Parents', 'Private Tenant', 'Council Tenant', 'Homeowner'), 
                                size = 1, 
                                prob = c(0.9, 0.01, 0.08, 0.01), 
                                replace = T),             
             age <= 30 ~ sample(c('Living with Parents', 'Private Tenant', 'Council Tenant', 'Homeowner'), 
                                size = 1, 
                                prob = c(0.6, 0.1, 0.1, 0.2), 
                                replace = T),
             age <= 40 ~ sample(c('Living with Parents', 'Private Tenant', 'Council Tenant', 'Homeowner'), 
                                size = 1, 
                                prob = c(0.01, 0.33, 0.33, 0.33), 
                                replace = T),
             age <= 50 ~ sample(c('Living with Parents', 'Private Tenant', 'Council Tenant', 'Homeowner'), 
                                size = 1, 
                                prob = c(0.01, 0.33, 0.33, 0.33), 
                                replace = T),
             TRUE ~ sample(c('Living with Parents', 'Private Tenant', 'Council Tenant', 'Homeowner'), 
                           size = 1, 
                           prob = c(0.0, 0.1, 0.15, 0.75),
                           replace = T)
             )}))



```

After creating information about the customer and their families, it is time to think about how customer's interact with our fake business. This will be kicked off with tenure, which will be the number of years the customer has been registered with the company. It is assumed that the customer's tenure can be modelled using a poisson distribution, but there are different underlying rates for different demographics.

```{r tenure}
# Tenure
df_customer <-    
  mutate(df_customer, 
         tenure = mapply(function(age, gender)
           {
             case_when(
               age <= 20 ~ mean(rpois(n = 10, lambda = 0.5)),
               age <= 30 & gender == "Female" ~ mean(rpois(n = 10, lambda = 5)),
               age <= 30 & gender == "Male" ~ mean(rpois(n = 10, lambda = 3)),
               age <= 40 & gender == "Female" ~ mean(rpois(n = 10, lambda = 7)),
               age <= 40 & gender == "Male" ~ mean(rpois(n = 10, lambda = 9)),
               age <= 50  & gender == "Female" ~ mean(rpois(n = 10, lambda = 3)),
               age <= 50  & gender == "Male" ~ mean(rpois(n = 10, lambda = 1)),
               TRUE ~ mean(rpois(n = 10, lambda = 2))
               )
           }, age, gender))
```

Using the same methodology as described above, lifetime sales and visits will also be generated for each customer. Using the same concept of sampling and conditioning, sales and visits are generated differently for different members of the customer base. The code has been hidden as it is slightly repetitive but can be viewed on my [github](https://github.com/registea/generating_synthetic_data/blob/master/generating_synthetic_data.rmd).

```{r visits_sales, echo=FALSE}
 # Visits
df_customer <-    
  mutate(df_customer, 
         visits = mapply(function(age, gender, tenure, living_status)
           {
             case_when(
               age <= 20 & gender == "Female" & tenure <= 2 ~ mean(rpois(n = 10, lambda = 3)),
               age <= 20 & gender == "Female" & tenure > 2 ~ mean(rpois(n = 10, lambda = 1)),               
               age <= 20 & gender == "Male" & tenure <= 2  ~ mean(rpois(n = 10, lambda = 5)),
               age <= 20 & gender == "Male" & tenure > 2  ~ mean(rpois(n = 10, lambda = 1)),
               
               age <= 30 & gender == "Female" & living_status %in% c('Private Tenant', 'Council Tenant') ~ mean(rpois(n = 10, lambda = 6)),
               age <= 30 & gender == "Female" & living_status %in% c('Homeowner') ~ mean(rpois(n = 10, lambda = 8)),               
               age <= 30 & gender == "Male" & living_status %in% c('Private Tenant', 'Council Tenant') ~ mean(rpois(n = 10, lambda = 3)),
               age <= 30 & gender == "Male" & living_status %in% c('Homeowner') ~ mean(rpois(n = 10, lambda = 15)),   
               age <= 30 & living_status %in% c('Living with Parents') ~ mean(rpois(n = 10, lambda = 2)),   
               
               age <= 40 & gender == "Female" & tenure <= 5 ~ mean(rpois(n = 10, lambda = 9)),
               age <= 40 & gender == "Female" & tenure > 5 ~ mean(rpois(n = 10, lambda = 18)),               
               age <= 40 & gender == "Male" & tenure <= 5  ~ mean(rpois(n = 10, lambda = 5)),
               age <= 40 & gender == "Male" & tenure > 5  ~ mean(rpois(n = 10, lambda = 6)),
               
               age <= 50 & gender == "Female" & living_status %in% c('Private Tenant', 'Council Tenant') ~ mean(rpois(n = 10, lambda = 2)),
               age <= 50 & gender == "Female" & living_status %in% c('Homeowner') ~ mean(rpois(n = 10, lambda = 1.5)),               
               age <= 50 & gender == "Male" & living_status %in% c('Private Tenant', 'Council Tenant') ~ mean(rpois(n = 10, lambda = 3)),
               age <= 50 & gender == "Male" & living_status %in% c('Homeowner') ~ mean(rpois(n = 10, lambda = 5)),   
               age <= 50 & living_status %in% c('Living with Parents') ~ mean(rpois(n = 10, lambda = 0.5)),   
               
               TRUE ~ mean(rpois(n = 10, lambda = 10))
               )
           }, age, gender, tenure, living_status),
         visits = ceiling(visits)
         )

# Sales
df_customer <-    
  mutate(df_customer, 
         sales = visits * mapply(function(age, gender, no_children, marital_status)
           {
             case_when(
               age <= 20 & gender == "Female" & no_children <= 1 ~ mean(rpois(n = 10, lambda = 250)),
               age <= 20 & gender == "Female" & no_children > 1 ~ mean(rpois(n = 10, lambda = 150)),               
               age <= 20 & gender == "Male" & no_children <= 1  ~ mean(rpois(n = 10, lambda = 300)),
               age <= 20 & gender == "Male" & no_children > 1  ~ mean(rpois(n = 10, lambda = 120)),
               
               age <= 30 & gender == "Female" & marital_status %in% c('Cohabiting','Married') ~ mean(rpois(n = 10, lambda = 750)),
               age <= 30 & gender == "Female" & marital_status %in% c('Single') ~ mean(rpois(n = 10, lambda = 1000)),               
               age <= 30 & gender == "Male" & marital_status %in% c('Cohabiting','Married') ~ mean(rpois(n = 10, lambda = 690)),
               age <= 30 & gender == "Male" & marital_status %in% c('Single') ~ mean(rpois(n = 10, lambda = 950)),   
               age <= 30 & marital_status %in% c('Other') ~ mean(rpois(n = 10, lambda = 60)),   
               
               age <= 40 & gender == "Female" & no_children <= 2 ~ mean(rpois(n = 10, lambda = 1500)),
               age <= 40 & gender == "Female" & no_children > 2 ~ mean(rpois(n = 10, lambda = 1200)),               
               age <= 40 & gender == "Male" & no_children <= 2  ~ mean(rpois(n = 10, lambda = 2000)),
               age <= 40 & gender == "Male" & no_children > 2  ~ mean(rpois(n = 10, lambda = 1800)),
               
               age <= 50 & gender == "Female" & marital_status %in% c('Cohabiting','Married') ~ mean(rpois(n = 10, lambda = 3000)),
               age <= 50 & gender == "Female" & marital_status %in% c('Single') ~ mean(rpois(n = 10, lambda = 5000)),               
               age <= 50 & gender == "Male" & marital_status %in% c('Cohabiting','Married') ~ mean(rpois(n = 10, lambda = 3000)),
               age <= 50 & gender == "Male" & marital_status %in% c('Single') ~ mean(rpois(n = 10, lambda = 5000)),   
               age <= 50 & marital_status %in% c('Other') ~ mean(rpois(n = 10, lambda = 50)),   
               
               TRUE ~ mean(rpois(n = 10, lambda = 1000))
               )
           }, age, gender, no_children, marital_status))
```

# Summary Analysis

Now that a dataset has been created, we can take a peek at the first 20 rows to get a feel for the data.

```{r tablehead, echo=FALSE}
# summary table
knitr::kable(head(df_customer, n = 20), align = c('c','c','c','c','c','c','c','c','c'))
```

From the print out above we can see a diverse distribution of data within each field indicating the generation has worked as expected. This is further visualised in the plot below which visualises the sales data across multiple customer attributes. We can see that some potentially realistic distributions in the data are reflected across different customer cohorts based on age, gender and living_status.

```{r graphic, echo=FALSE, fig.width=10}
# summary visual
df_customer %>%
  mutate(age = case_when(age <= 21 ~ '18-20',
                         age <= 30 ~ '21-30',
                         age <= 40 ~ '31-40',
                         age <= 50 ~ '41-50',
                         TRUE ~ '50+'
                         )) %>%
  ggplot(aes(x = living_status, y =sales, fill = gender)) +
  geom_boxplot(alpha = 0.8) +
  facet_grid(. ~ age) + 
  theme(axis.text.x = element_text(angle = 90),
        plot.title = element_text(hjust = 0.5),
        legend.position = "top") +
  scale_y_continuous(labels = scales::comma) +
  labs(x = "Living status", y = "Sales") +
  ggtitle("Visualising Generated Data")

```

# Conclusion

This was a simple example of how data can be generated with underlying patterns of varying complexity. The principle and the code is relatively simple and can be used to generate a variety of datasets of different sizes for different purposes. It is likely these principles will be used in my upcoming projects.